name: CI/CD Pipeline

# ─────────────────────────────────────────────────────────────────────────────
# Runs on every push to main/develop and on every PR targeting those branches.
# Orchestrates three concerns:
#   1. CI (build + lint + test)   — delegates to ci-reusable.yml
#   2. Security scanning          — delegates to codeql.yml + dependency-review
#   3. Final gate                 — ensures all required jobs succeeded
# ─────────────────────────────────────────────────────────────────────────────

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  # Minimum permissions — jobs declare additional permissions as needed.
  contents: read

jobs:
  # ── 1. CI via reusable template ──────────────────────────────────────────
  ci:
    name: CI
    uses: ./.github/workflows/ci-reusable.yml
    with:
      python-version: '3.11'
      node-version: '18'
      backend-dir: './backend'
      frontend-dir: './web'
      run-backend-tests: true
      run-frontend-tests: true
      run-security-scan: true
    secrets:
      codecov-token: ${{ secrets.CODECOV_TOKEN }}

  # ── 2. CodeQL static security analysis ──────────────────────────────────
  codeql:
    name: CodeQL
    uses: ./.github/workflows/codeql.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  # ── 3. Dependency review (PRs only) ─────────────────────────────────────
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    # Informational only — requires "Dependency graph" feature to be enabled in
    # repo settings (Security → Code security and analysis → Dependency graph).
    # continue-on-error: true ensures this doesn't block the CI gate when the
    # feature is not enabled (e.g. on forks).
    continue-on-error: true
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          # Only comment when vulnerabilities are found — avoids noise on clean PRs.
          comment-summary-in-pr: on-failure

  # ── 4. Gate — all required checks must pass ──────────────────────────────
  all-checks-passed:
    name: All Checks Passed
    # dependency-review uses continue-on-error, so its result is always "success"
    # (even if steps failed). Including it here surfaces its status without
    # blocking the gate on forks where the dependency graph is not enabled.
    needs: [ ci, codeql, dependency-review ]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read

    steps:
      - name: Verify all required jobs succeeded
        run: |
          ci_result="${{ needs.ci.result }}"
          codeql_result="${{ needs.codeql.result }}"
          dep_review_result="${{ needs.dependency-review.result }}"

          echo "CI result               : $ci_result"
          echo "CodeQL result           : $codeql_result"
          echo "Dependency review result: $dep_review_result"

          # CodeQL is "skipped" when all changed files match paths-ignore — acceptable.
          # dependency-review is "skipped" on push events (PR-only) — acceptable.
          # dependency-review uses continue-on-error so its result is always "success".
          if [[ "$ci_result" == "success" && \
                ( "$codeql_result" == "success" || "$codeql_result" == "skipped" ) && \
                ( "$dep_review_result" == "success" || "$dep_review_result" == "skipped" ) ]]; then
            echo "✅ All required checks passed — PR is eligible for merge."
            exit 0
          else
            echo "❌ One or more required checks failed. Merge blocked."
            exit 1
          fi
