name: CI/CD Pipeline

# ─────────────────────────────────────────────────────────────────────────────
# Runs on every push to main/develop and on every PR targeting those branches.
# Orchestrates three concerns:
#   1. CI (build + lint + test)   — delegates to ci-reusable.yml
#   2. Security scanning          — delegates to codeql.yml + dependency-review
#   3. Final gate                 — ensures all required jobs succeeded
# ─────────────────────────────────────────────────────────────────────────────

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  # Minimum permissions — jobs declare additional permissions as needed.
  contents: read

jobs:
  # ── 1. CI via reusable template ──────────────────────────────────────────
  ci:
    name: CI
    uses: ./.github/workflows/ci-reusable.yml
    with:
      python-version: '3.11'
      node-version: '18'
      backend-dir: './backend'
      frontend-dir: './web'
      run-backend-tests: true
      run-frontend-tests: true
      run-security-scan: true
    secrets:
      codecov-token: ${{ secrets.CODECOV_TOKEN }}

  # ── 2. CodeQL static security analysis ──────────────────────────────────
  codeql:
    name: CodeQL
    uses: ./.github/workflows/codeql.yml
    permissions:
      actions: read
      contents: read
      security-events: write

  # ── 3. Dependency review (PRs only) ─────────────────────────────────────
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          comment-summary-in-pr: always

  # ── 4. Gate — all required checks must pass ──────────────────────────────
  all-checks-passed:
    name: All Checks Passed
    needs: [ ci, codeql ]
    runs-on: ubuntu-latest
    if: always()
    permissions:
      contents: read

    steps:
      - name: Verify all required jobs succeeded
        run: |
          ci_result="${{ needs.ci.result }}"
          codeql_result="${{ needs.codeql.result }}"

          echo "CI result    : $ci_result"
          echo "CodeQL result: $codeql_result"

          # CodeQL is "skipped" when all changed files match paths-ignore in
          # codeql.yml (e.g. docs-only PRs) — that is an acceptable outcome.
          if [[ "$ci_result" == "success" && \
                ( "$codeql_result" == "success" || "$codeql_result" == "skipped" ) ]]; then
            echo "✅ All required checks passed — PR is eligible for merge."
            exit 0
          else
            echo "❌ One or more required checks failed. Merge blocked."
            exit 1
          fi
