name: PR Automation

# Runs on every PR to apply labels, detect PR size, and request Copilot review.

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. Auto-label based on changed file paths (uses labeler.yml)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  label-pr:
    name: Label PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Apply path-based labels
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. Detect PR size and label accordingly
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  size-label:
    name: PR Size Label
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Calculate PR size and apply label
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const total = pr.additions + pr.deletions;

            let sizeLabel;
            if (total <= 10)        sizeLabel = 'size/XS';
            else if (total <= 50)   sizeLabel = 'size/S';
            else if (total <= 200)  sizeLabel = 'size/M';
            else if (total <= 500)  sizeLabel = 'size/L';
            else                    sizeLabel = 'size/XL';

            const sizeLabels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];

            // Size labels are created by setup-repo.yml; no per-PR creation needed.
            // Remove any stale size label then apply the correct one.
            const currentLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
            });
            for (const label of currentLabels.data) {
              if (sizeLabels.includes(label.name)) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: label.name,
                });
              }
            }
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel],
            });
            core.info(`Applied size label: ${sizeLabel} (${total} lines changed)`);

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. Request GitHub Copilot code review
  #    Requires GitHub Copilot Enterprise / Copilot Business with
  #    code review enabled on the repository.
  #    Falls back gracefully if not available.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  request-copilot-review:
    name: Request Copilot Review
    runs-on: ubuntu-latest
    if: |
      github.event.action == 'opened' &&
      github.event.pull_request.draft == false

    steps:
      - name: Request Copilot as reviewer
        uses: actions/github-script@v7
        continue-on-error: true   # non-fatal: Copilot review is best-effort
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 'copilot' is the GitHub login for the Copilot code review bot.
            // Requires GitHub Copilot Enterprise or Copilot Business with
            // the "Copilot code review" feature enabled on this repository.
            // See: https://docs.github.com/en/copilot/using-github-copilot/code-review/using-copilot-code-review
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: ['copilot'],
              });
              core.info('Copilot review requested successfully.');
            } catch (e) {
              core.warning(`Could not request Copilot review: ${e.message}`);
              core.warning('Ensure GitHub Copilot code review is enabled for this repository.');
            }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. Post PR summary comment with quality checklist
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pr-welcome-comment:
    name: Post PR Summary
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'

    steps:
      - name: Post welcome and checklist comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const lines = [
              '## ðŸ¤– Automated PR Checks',
              '',
              'All the following checks run automatically on this PR. The PR will be eligible',
              'for auto-merge once **every required check passes**.',
              '',
              '| Check | Status |',
              '|-------|--------|',
              '| ðŸ” Backend Lint & Test | Runs on push |',
              '| ðŸŽ¨ Frontend Lint & Build | Runs on push |',
              '| ðŸ›¡ï¸ CodeQL Security Scan | Runs on push |',
              '| ðŸ“¦ Dependency Review | Runs on PR |',
              '| ðŸ”’ Vulnerability Scan | Runs on push |',
              '| âœ… All Checks Gate | Required before merge |',
              '',
              '**Copilot code review** has been requested. Address any feedback before merging.',
              '',
              '> ðŸ’¡ Add the `auto-merge` label to enable automatic squash-merge once all checks pass.',
            ];
            const body = lines.join('\n');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body,
            });
